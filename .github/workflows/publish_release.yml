name: Manual KMP Release
on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' # Trigger on tags like v0.0.1 pushed to aura-core

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 1. Build XCFramework
      - name: Build XCFramework
        run: ./gradlew :shared:assembleSharedXCFramework

      # 2. Zip and Checksum
      - name: Zip XCFramework
        run: |
          cd shared/build/XCFrameworks/release
          zip -r Shared.xcframework.zip Shared.xcframework
          
          # Calculate checksum
          CHECKSUM=$(swift package compute-checksum Shared.xcframework.zip)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
          
          # Move zip to a clean distribution folder
          mkdir -p ../../../../dist
          mv Shared.xcframework.zip ../../../../dist/

      # 3. Create Release on DISTRIBUTION Repo (aura-spm) & Upload Zip
      # This action allows us to publish to a different repository!
      - name: Release to aura-spm
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.DISTRIBUTION_REPO_PAT }} # ðŸ‘ˆ Must use PAT to write to other repo
          repository: Helmy2/aura-spm               # ðŸ‘ˆ Target Repo
          tag_name: ${{ github.ref_name }}          # Use same tag as source (e.g. v0.0.1)
          files: dist/Shared.xcframework.zip
          generate_release_notes: true

      # 4. Checkout Distribution Repo to update Package.swift
      - name: Checkout Distribution Repo
        uses: actions/checkout@v4
        with:
          repository: Helmy2/aura-spm
          token: ${{ secrets.DISTRIBUTION_REPO_PAT }}
          path: distribution-repo
          ref: main

      # 5. Update Package.swift in aura-spm
      - name: Update Package.swift
        run: |
          cd distribution-repo
          
          VERSION=${GITHUB_REF#refs/tags/}
          
          # URL now points to AURA-SPM releases
          URL="https://github.com/Helmy2/aura-spm/releases/download/$VERSION/Shared.xcframework.zip"
          
          echo "Updating Package.swift..."
          echo "URL: $URL"
          
          # Generate file from scratch
          cat > Package.swift <<EOF
          // swift-tools-version:5.3
          import PackageDescription

          let package = Package(
              name: "Shared",
              platforms: [
                  .iOS(.v13)
              ],
              products: [
                  .library(
                      name: "Shared",
                      targets: ["Shared"]
                  ),
              ],
              targets: [
                  .binaryTarget(
                      name: "Shared",
                      url: "$URL",
                      checksum: "${{ env.CHECKSUM }}"
                  ),
              ]
          )
          EOF
          
          # Commit and Push
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add Package.swift
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update Package.swift for $VERSION"
            git push origin main
          fi

  publish-android:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # ðŸ‘ˆ REQUIRED: To upload to GitHub Packages
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # This publishes the Android AAR (and other KMP targets like JVM/Linux if you have them)
      # to the GitHub Packages Maven repository.
      - name: Publish Android to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
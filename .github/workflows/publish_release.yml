name: Manual KMP Release
on:
  workflow_dispatch: # Manual trigger
  push:
    tags:
      - 'v*' # Trigger on tags like v0.0.1

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 1. Build the XCFramework using standard Kotlin task
      - name: Build XCFramework
        run: ./gradlew :shared:assembleSharedXCFramework

      # 2. Zip the Framework
      - name: Zip XCFramework
        run: |
          cd shared/build/XCFrameworks/release
          zip -r Shared.xcframework.zip Shared.xcframework
          
          # Calculate Checksum
          CHECKSUM=$(swift package compute-checksum Shared.xcframework.zip)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
          
          # Move zip to root for easy access
          mv Shared.xcframework.zip ../../../../

      # 3. Create GitHub Release & Upload Zip
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: Shared.xcframework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. Update Package.swift with new URL and Checksum
      - name: Update Package.swift
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          URL="https://github.com/${{ github.repository }}/releases/download/$VERSION/Shared.xcframework.zip"
          
          # Replace Placeholders using sed
          sed -i '' "s|URL_PLACEHOLDER|$URL|g" Package.swift
          sed -i '' "s|CHECKSUM_PLACEHOLDER|${{ env.CHECKSUM }}|g" Package.swift
          
          # Commit the updated Package.swift back to the repo
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add Package.swift
          git commit -m "Update Package.swift for $VERSION"
          git push origin HEAD:main

  publish-android:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # ðŸ‘ˆ REQUIRED: To upload to GitHub Packages
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # This publishes the Android AAR (and other KMP targets like JVM/Linux if you have them)
      # to the GitHub Packages Maven repository.
      - name: Publish Android to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
name: KMMBridge Release
on:
  workflow_dispatch: # Allows manual triggering
  push:
    branches:
      - main # Run on pushes to main

permissions:
  contents: write # REQUIRED: To create releases and push tags

jobs:
  kmmbridge-publish:
    runs-on: macos-15 # Use latest macOS for Xcode compatibility
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 1. Build and Publish the XCFramework Zip to GitHub Releases
      - name: Publish to GitHub Releases
        run: ./gradlew kmmBridgePublish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GITHUB_ACTOR is automatically set by Actions, but good to be explicit if needed
          GITHUB_ACTOR: ${{ github.actor }}

      # 2. Update the Git Tag to point to this new release
      # This is CRITICAL for SPM to find the correct version
      - name: Update Release Tag
        uses: touchlab/ga-update-release-tag@v1
        id: update-release-tag
        with:
          tagVersion: ${{ steps.versionPropertyValue.outputs.propVal }} # Or your version logic
          # If you don't have a step outputting the version, you might need to hardcode or extract it
          # For simple setups, KMMBridge handles the tag creation, but this ensures the tag moves correctly.
